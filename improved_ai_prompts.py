#!/usr/bin/env python3
"""
改進版AI提取提示詞 - 提高準確度和完整性
基於C13A05954案例的經驗教訓
"""

# 招標公告提取提示詞 - 增強版
ANNOUNCEMENT_EXTRACTION_PROMPT_V2 = """你是政府採購專家，請從以下招標公告文件中精確提取25個標準欄位。

招標公告內容：
{content}

【重要提醒】
1. 仔細檢查每個數字，特別是金額和數量
2. 案名中的數字（如"3項"、"5項"）必須準確提取
3. 金額必須完整提取，注意萬元與元的差異
4. 特別注意「特殊採購」、「外國廠商」等關鍵設定

【提取規則】
1. 案號：完整提取，包含所有字母和數字（如C13A05954A）
2. 案名：完整提取，包含項目數量（如"電梯門機構皮帶傳動輪組等5項採購"）
3. 採購金額：提取實際數字，1,993,405應為1993405（注意是否為萬元）
4. 押標金：精確提取，39,000與390,000差異很大
5. 特殊採購：仔細查找是否有「本案屬特殊採購」的描述
6. 外國廠商：注意「不得參與」、「得參與」的區別

【數字驗證】
- 採購金額通常在10萬到1000萬之間
- 押標金通常是採購金額的1-5%
- 如果發現異常數字，請再次確認

請提取以下欄位並以JSON格式回答，如果找不到資訊請填入"NA"：

{{
  "案號": "精確案號如C13A05954",
  "案名": "完整案名，包含項目數量描述",
  "招標方式": "公開招標/公開取得報價或企劃書/限制性招標",
  "採購金額": "純數字（檢查是否為萬元單位）",
  "預算金額": "純數字（通常與採購金額相同）",
  "採購金級距": "未達公告金額/逾公告金額十分之一未達公告金額/逾公告金額",
  "依據法條": "政府採購法第XX條",
  "決標方式": "最低標/最有利標/最高標",
  "訂有底價": "是/否",
  "複數決標": "是/否",
  "依64條之2": "是/否",
  "標的分類": "財物/勞務/工程/買受定製",
  "適用條約": "是/否",
  "敏感性採購": "是/否",
  "國安採購": "是/否",
  "增購權利": "是/無",
  "特殊採購": "是/否（特別注意）",
  "統包": "是/否",
  "協商措施": "是/否",
  "電子領標": "是/否",
  "優先身障": "是/否",
  "外國廠商": "可/不可/得參與採購/不得參與採購",
  "限定中小企業": "是/否",
  "押標金": "純數字金額",
  "開標方式": "一次投標不分段開標/一次投標分段開標"
}}

【金額範圍參考】
- 公開取得報價：15萬-150萬
- 小額採購：10萬以下
- 公開招標：通常150萬以上

請仔細核對所有數字，確保準確性。"""

# 投標須知提取提示詞 - 增強版
REQUIREMENTS_EXTRACTION_PROMPT_V2 = """你是政府採購專家，請從以下投標須知內容中提取所有勾選項目和關鍵資訊。

投標須知內容：
{content}

【重要提醒】
1. ■表示已勾選，□表示未勾選
2. 注意互斥選項不應同時勾選（如保留/未保留增購）
3. 押標金要精確提取，注意數字單位
4. 特別注意第十五點（外國廠商）是否存在或被刪除

【特殊檢查項目】
1. 第十五點：如果公告禁止外國廠商，此點應為「十五、刪除。」
2. 押標金：檢查是否有多個金額，取正確的那個
3. 底價公告：注意「公告底價」與「不公告底價」的區別
4. 開標方式：第四十二點應只勾選一種方式

請分析文件並以JSON格式回答：

{{
  "案號": "提取案號（如C13A05954）",
  "採購標的名稱": "完整標案名稱（注意項目數量）",
  "第3點逾公告金額十分之一": "已勾選/未勾選",
  "第4點非特殊採購": "已勾選/未勾選",
  "第5點逾公告金額十分之一": "已勾選/未勾選",
  "第6點訂底價": "已勾選（公告）/已勾選（不公告）/未勾選",
  "第7點保留增購": "已勾選/未勾選",
  "第7點未保留增購": "已勾選/未勾選",
  "第8點條約協定": "已勾選/未勾選",
  "第8點可參與": "已勾選/未勾選",
  "第8點不可參與": "已勾選/未勾選",
  "第8點禁止大陸": "已勾選/未勾選",
  "第9點電子領標": "已勾選/未勾選",
  "第13點敏感性": "已勾選/未勾選",
  "第13點國安": "已勾選/未勾選",
  "第15點外國廠商": "存在/刪除",
  "第19點無需押標金": "已勾選/未勾選",
  "第19點一定金額": "已勾選/未勾選",
  "第35點非統包": "已勾選/未勾選",
  "第42點不分段": "已勾選/未勾選",
  "第42點分二段": "已勾選/未勾選",
  "第54點不協商": "已勾選/未勾選",
  "第59點最低標": "已勾選/未勾選",
  "第59點非64條之2": "已勾選/未勾選",
  "第59點身障優先": "已勾選/未勾選",
  "押標金金額": "提取押標金數字（如390000）",
  "底價公告設定": "公告底價/不公告底價"
}}

【數字驗證】
- 押標金通常是採購金額的1-5%
- 如果看到多個金額，選擇合理的那個
- 注意新臺幣後面的數字單位

請確保所有勾選狀態準確，特別注意互斥選項。"""

# 綜合驗證提示詞 - 新增
CROSS_VALIDATION_PROMPT = """你是招標文件審核專家，請執行交叉驗證以確保資料準確性。

招標公告摘要：
- 案號: {announcement_case_no}
- 案名: {announcement_name}
- 採購金額: {announcement_amount}
- 招標方式: {tender_method}
- 押標金: {announcement_bond}

投標須知摘要：
- 案號: {requirements_case_no}
- 案名: {requirements_name}
- 押標金: {requirements_bond}

請執行以下驗證並回答（JSON格式）：

{{
  "金額合理性": {{
    "採購金額是否合理": "是/否",
    "押標金比例": "計算押標金佔採購金額的百分比",
    "金額單位檢查": "確認是否有萬元/元的混淆"
  }},
  "案名一致性": {{
    "項目數量是否一致": "是/否",
    "差異說明": "如果不一致，說明差異"
  }},
  "招標方式合規性": {{
    "金額是否符合招標方式": "是/否",
    "說明": "如公開取得報價應在15-150萬"
  }},
  "數據修正建議": {{
    "需要修正的欄位": ["欄位1", "欄位2"],
    "修正值": {{"欄位名": "建議值"}}
  }}
}}

【驗證重點】
1. 公開取得報價金額上限150萬
2. 押標金通常為採購金額的1-5%
3. 案名中的數量描述必須一致
4. 注意萬元與元的單位差異"""

# 智能修復提示詞
AUTO_FIX_PROMPT = """你是資料修復專家，請根據以下資訊判斷並修復可能的錯誤。

原始資料：
{original_data}

可能的問題：
{potential_issues}

請分析並提供修復建議（JSON格式）：

{{
  "修復項目": [
    {{
      "欄位": "欄位名稱",
      "原值": "原始值",
      "修正值": "建議修正值",
      "修復原因": "說明為何需要修復",
      "信心度": "高/中/低"
    }}
  ],
  "無法自動修復": [
    {{
      "欄位": "欄位名稱",
      "問題": "問題描述",
      "建議": "人工處理建議"
    }}
  ]
}}

【修復原則】
1. 優先修復明顯的數字錯誤（如單位錯誤）
2. 保守處理不確定的資訊
3. 標註需要人工確認的項目"""

# 使用範例
def demonstrate_improved_prompts():
    """展示如何使用改進的提示詞"""
    
    print("=== 改進的AI提取提示詞 ===")
    print("\n1. 招標公告提取 - 加強數字驗證和案名準確性")
    print("   - 特別注意項目數量（3項 vs 5項）")
    print("   - 金額單位驗證（萬元 vs 元）")
    print("   - 特殊採購等關鍵欄位")
    
    print("\n2. 投標須知提取 - 改善勾選識別")
    print("   - 互斥選項檢查")
    print("   - 第十五點存在性檢查")
    print("   - 底價公告設定區分")
    
    print("\n3. 交叉驗證 - 新增資料合理性檢查")
    print("   - 金額範圍驗證")
    print("   - 押標金比例計算")
    print("   - 招標方式合規性")
    
    print("\n4. 智能修復 - 自動修正常見錯誤")
    print("   - 單位錯誤修正")
    print("   - 數字合理性判斷")
    print("   - 人工確認提示")
    
    # 實際應用示例
    example_usage = """
    # 使用改進的提示詞
    extractor = EnhancedAIExtractor()
    
    # 1. 提取時使用新提示詞
    announcement_data = extractor.extract_with_prompt(
        content, 
        ANNOUNCEMENT_EXTRACTION_PROMPT_V2
    )
    
    # 2. 交叉驗證
    validation_result = extractor.cross_validate(
        announcement_data,
        requirements_data,
        CROSS_VALIDATION_PROMPT
    )
    
    # 3. 自動修復
    if validation_result['需要修復']:
        fixed_data = extractor.auto_fix(
            announcement_data,
            validation_result['問題'],
            AUTO_FIX_PROMPT
        )
    """
    
    print("\n=== 實際應用示例 ===")
    print(example_usage)
    
    print("\n=== 預期改進效果 ===")
    print("1. 案名識別準確度提升（能識別3項vs5項）")
    print("2. 金額提取準確度提升（199萬不會誤判為39萬）")
    print("3. 特殊採購等關鍵欄位準確度提升")
    print("4. 押標金識別準確度提升（39,000 vs 390,000）")
    print("5. 第十五點刪除檢測能力")

if __name__ == "__main__":
    demonstrate_improved_prompts()